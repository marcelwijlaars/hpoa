<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><!--
*
*  Copyright 2006-2014 Hewlett-Packard Development Company, L.P.
*
-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Power Regulator - Power Meter Readings</title>
  <style type="text/css">
    /* this is ignored by Netscape 4 */
    table.mwjgraph { border: 2px solid #000; }
    body.body-fit{padding:0px;margin:10px;}
    * html body.body-fit{padding:0px;margin:10px;width:92%}
    
    table.graphWrapperTable{padding-left: 0px; padding-right: 0px; white-space:nowrap;}
    * html table.graphWrapperTable{padding-left: 0px; padding-right: 0px;}
  </style>
  <link rel="stylesheet" type="text/css" href="../css/default.css" />
  <link rel="stylesheet" type="text/css" href="../css/blue_theme.css" />
  <link rel="stylesheet" type="text/css" href="../css/MxPortalEx.css" />
  <link rel="stylesheet" type="text/css" href="../css/widgets.css" />
  <link rel="stylesheet" type="text/css" href="../Help/stylesheets/help.css"/>
  <script type="text/javascript" src="../js/linechart.js"></script>
  <script type="text/javascript" src="../js/helpTips.js"></script>
  <script type="text/javascript" src="../js/EnvironConstants.js"></script>
  <script type="text/javascript" src="../js/buttonManager.js"></script>
  <script type="text/javascript" src="../js/tabManager.js"></script>
  <script type="text/javascript" src="../js/global.js"></script>
  <script type="text/javascript" src="../js/formManager.js"></script>
  <script type="text/javascript" src="../js/displayManager.js"></script>
  <script type="text/javascript" src="../js/browser.js"></script>
  <script type="text/javascript" src="../js/init.js"></script>
  <script type="text/javascript" src="../js/xml.js"></script>
  <script type="text/javascript" src="../js/xslt.js"></script>
  
  <script type="text/javascript">
var encNum;
var hpem=null;
var powerLog=null;
var me=this;
var oa1chart=null;
var oa1chartPeakA=null;
var oa1chartPeakB=null
var maxPower=null;
var minPower=null;
var avePower=null;
var validTime=null;
var validDate=null;
var curAvePower=null;
var curPowerCap=0;
var presentPower=null;
var isDC=false;
var isRedundant=false;
var vslider=null;
var hslider=null;
var sortOrder='asc';
var unitLabels=new Array();
unitLabels["amps"]=top.getString("amps");
unitLabels["btus"]=top.getString("btus");
unitLabels["watts"]=top.getString("watts");
var inWatts=true;
var avgUnits="watts";
var peakUnits="amps";
var lineVoltagePreference=null;
var lineVoltage=220;
var threePhaseFactor=1;
var showPeak=null;
var showAverage=null;
var showMin=null;
var showCap=null;
var showDerated=null;
var showRated=null;
this.childFrameReady=function(canvasName){
displayGraph(canvasName);
}
function initVars(){
maxPower=parseInt(document.getElementById('maxPowerValue').value);
minPower=parseInt(document.getElementById('minPowerValue').value);
avePower=parseInt(document.getElementById('avePowerValue').value);
curAvePower=parseInt(document.getElementById('curAvePowerValue').value);
presentPower=parseInt(document.getElementById('presentPowerValue').value);
}
function initPowerConversion(powerCapConfigDoc){
try{
if(lineVoltagePreference!=null){
lineVoltage=lineVoltagePreference;
}else{
var voltage=getElementValueXpath(powerCapConfigDoc,'//hpoa:enclosureEstimatedVoltage');
if(voltage!=''){
voltage=parseInt(voltage);
if(!isNaN(voltage))lineVoltage=voltage;
}
}
}catch(e){};
try{
var phaseType=getElementValueXpath(powerCapConfigDoc,'//hpoa:enclosureAcPhaseType');
if(phaseType=='2012')threePhaseFactor=1;
if(phaseType=='2010')threePhaseFactor=3;
if(phaseType=='2011')threePhaseFactor=1.732;
}catch(e){};
}
function getNewGraph(){
try{
var w=null;
try{
w=me.oa1chart.getBarWidth();
}catch(e){}
var s=me.oa1chart.buildBarGraph('bargraph',w);
document.getElementById('bargraph').innerHTML=s;
updateTickLabels(me.oa1chart,'');
}catch(e2){}
try{
var w=null;
try{
w=me.oa1chartPeakA.getBarWidth();
}catch(e){}
var s=me.oa1chartPeakA.buildBarGraph('bargraphPeakSideA',w);
document.getElementById('bargraphPeakSideA').innerHTML=s;
updateTickLabels(me.oa1chartPeakA,'PeakSideA');
}catch(e2){}
if(isRedundant)try{
var w=null;
try{
w=me.oa1chartPeakB.getBarWidth();
}catch(e){}
var s=me.oa1chartPeakB.buildBarGraph('bargraphPeakSideB',w);
document.getElementById('bargraphPeakSideB').innerHTML=s;
updateTickLabels(me.oa1chartPeakB,'PeakSideB');
}catch(e2){}
}
function showBar(name,checked){
var field;
if(name=="peak")field=USER_PREFERENCES_SHOW_PEAK_POWER();
if(name=="average")field=USER_PREFERENCES_SHOW_AVERAGE_POWER();
if(name=="min")field=USER_PREFERENCES_SHOW_MIN_POWER();
if(name=="cap")field=USER_PREFERENCES_SHOW_POWER_CAP();
if(name=="derated")field=USER_PREFERENCES_SHOW_DERATED();
if(name=="rated")field=USER_PREFERENCES_SHOW_RATED();
if(field!=null){
setUserPreference(field,checked);
}
if(me.oa1chart){
me.oa1chart.showBar(name,checked);
var s=me.oa1chart.buildBarGraph('bargraph',null);
document.getElementById('bargraph').innerHTML=s;
}
if(name=="rated"){
if(me.oa1chartPeakA){
me.oa1chartPeakA.showBar(name,checked);
var s=me.oa1chartPeakA.buildBarGraph('bargraph',null);
document.getElementById('bargraphPeakSideA').innerHTML=s;
}
if(me.oa1chartPeakB){
me.oa1chartPeakB.showBar(name,checked);
var s=me.oa1chartPeakB.buildBarGraph('bargraph',null);
document.getElementById('bargraphPeakSideB').innerHTML=s;
}
}
}
function loadContent(){
try{
top.mainPage.setMainTitle(top.getString('encPowerMeter'));
inWatts=assertTrue(getUserPreference(USER_PREFERENCES_SHOW_IN_WATTS()));
avgUnits=getUserPreference(USER_PREFERENCES_UNITS_FOR_AVG());
if(avgUnits==null)avgUnits="watts";
peakUnits=getUserPreference(USER_PREFERENCES_UNITS_FOR_PEAK());
if(peakUnits==null)peakUnits="amps";
var voltPref=getUserPreference(USER_PREFERENCES_VOLTAGE());
if(voltPref!=null)voltPref=parseInt(voltPref);
if(!isNaN(voltPref))lineVoltagePreference=voltPref;
}catch(e){}
encNum=parseInt(getSearchValue(location.search,'encNum'));
if(!isNaN(encNum)&&(hpem=top.mainPage.getHiddenFrame().getProxy(encNum))!=null){
selectTab('powerMeter');
}else{
displayContentFailed('tabContent',[top.getString('noOnboardAdmin')]);
}
}
function getCurrentTab(){
return ourTabManager.getCurrentTab();
}
function selectTab(tabId,fresh){
setTabContent(tabId,fresh);
}
var tableRenderId=0;
function setTabContent(tabId,fresh){
var contextId="FORM_POWER_METER";
var tab=document.getElementById(tabId);
if(tab){
contextId=tab.getAttribute("contextId");
}
top.mainPage.getHelpLauncher().setCurrentTopic(contextId);
try{
var formMgr=new FormManager(function(success){
if(success){
if(powerLog==null||fresh==true){
powerLog=formMgr.getDataByCallName("getEnclosurePowerData");
}
var samples=parseInt(getElementValueXpath(powerLog,'//hpoa:sampleCount'));
if(samples=="NaN"||samples<1){
displayContentFailed('tabContent',[top.getString('noPwrReadingAvailable1')+" "+top.getString('note:')+"<em>"+top.getString('noPwrReadingAvailable2')+"</em>"],AlertMsgTypes.Information);
}else{
var powerSubsystemInfoDoc=formMgr.getDataByCallName("getPowerSubsystemInfo");
var subsystemType=getElementValueXpath(powerSubsystemInfoDoc,'//hpoa:subsystemType');
isDC=(subsystemType=='EXTERNAL_DC');
if(isDC){
unitLabels["watts"]=top.getString("watts")+String.fromCharCode(160)+"DC";
}else{
unitLabels["watts"]=top.getString("watts")+String.fromCharCode(160)+"AC";
}
var redundancyMode=getElementValueXpath(powerSubsystemInfoDoc,'//hpoa:redundancyMode');
isRedundant=(redundancyMode=='AC_REDUNDANT');
var powerCapConfigDoc=formMgr.getDataByCallName("getPowerCapConfig");
var cap=parseInt(getElementValueXpath(powerCapConfigDoc,'//hpoa:powerCap'));
if(!isNaN(cap)){
curPowerCap=cap;
}
initPowerConversion(powerCapConfigDoc);
if(tabId=='powerMeterTable'){
renderTable();
}else if(tabId=='powerMeter'){
showPeak=assertTrue(getUserPreference(USER_PREFERENCES_SHOW_PEAK_POWER()));
showAverage=assertTrue(getUserPreference(USER_PREFERENCES_SHOW_AVERAGE_POWER()));
showMin=assertFalse(getUserPreference(USER_PREFERENCES_SHOW_MIN_POWER()));
showCap=assertTrue(getUserPreference(USER_PREFERENCES_SHOW_POWER_CAP()));
showDerated=assertTrue(getUserPreference(USER_PREFERENCES_SHOW_DERATED()));
showRated=assertTrue(getUserPreference(USER_PREFERENCES_SHOW_RATED()));
if(!showMin&&!showAverage&&!showCap){
showPeak=true;
showAverage=true;
showMin=false;
showCap=true;
showDerated=true;
showRated=true;
}
var processor=new XsltProcessor('../Templates/powerMeter.xsl');
processor.addParameter('showPeak',showPeak);
processor.addParameter('showAverage',showAverage);
processor.addParameter('showMin',showMin);
processor.addParameter('showCap',showCap);
processor.addParameter('showDerated',showDerated);
processor.addParameter('showRated',showRated);
processor.addParameter('avgUnits',avgUnits);
processor.addParameter('peakUnits',peakUnits);
processor.addParameter('lineVoltage',lineVoltage);
processor.addParameter('stringsDoc',top.getStringsDoc());
processor.addParameter('enclosurePowerDataDoc',powerLog);
processor.addParameter('powerSubsystemInfoDoc',powerSubsystemInfoDoc);
processor.addParameter('powerCapConfigDoc',powerCapConfigDoc);
document.getElementById('tabContent').innerHTML=processor.getOutput();
if(!isRedundant){
me.oa1chart=new LineChart(LogDeviceType.OA,powerLog,"oalinegraphOut","oalinegraphIn",true,true);
me.oa1chartPeakA=new LineChart(LogDeviceType.OA,powerLog,"oaPowerlinegraphOut","oapowerlinegraphIn",true,true);
}else{
me.oa1chart=new LineChart(LogDeviceType.OA,powerLog,"oalinegraphOut","oalinegraphIn",false,false);
me.oa1chartPeakA=new LineChart(LogDeviceType.OA,powerLog,"oaPowerlinegraphOut","oapowerlinegraphIn",true,false);
me.oa1chartPeakA.setGraphTitle(top.getString('leftSideGraphLabel'));
me.oa1chartPeakB=new LineChart(LogDeviceType.OA,powerLog,"oaPowerlinegraphOut","oapowerlinegraphIn",false,true);
me.oa1chartPeakB.setGraphTitle(top.getString('rightSideGraphLabel'));
}
if(tabId=='powerMeter'||me.oa1chart){
me.oa1chart.showBar("peak",false);
me.oa1chart.showBar("average",showAverage);
me.oa1chart.showBar("min",showMin);
me.oa1chart.showBar("cap",showCap);
me.oa1chart.showBar("derated",showDerated);
me.oa1chart.showBar("rated",showRated);
me.oa1chartPeakA.showBar("peak",true);
me.oa1chartPeakA.showBar("average",false);
me.oa1chartPeakA.showBar("min",false);
me.oa1chartPeakA.showBar("cap",false);
me.oa1chartPeakA.showBar("derated",false);
me.oa1chartPeakA.showBar("rated",showRated);
if(isRedundant){
me.oa1chartPeakB.showBar("peak",true);
me.oa1chartPeakB.showBar("average",false);
me.oa1chartPeakB.showBar("min",false);
me.oa1chartPeakB.showBar("cap",false);
me.oa1chartPeakB.showBar("derated",false);
me.oa1chartPeakB.showBar("rated",showRated);
}
}
getNewGraph();
initVars();
convert();
}
reconcilePage();
}
}else{
var emNum=hpem.getOaBayNumber(ACTIVE());
var oaInfo=hpem.getOaInfo(emNum);
var fwVersion=getElementValueXpath(oaInfo,'//hpoa:fwVersion');
if(Number(fwVersion)<Number(1.20)){
displayContentFailed('tabContent',[" This Onboard Administrator has an older firmware version.","Please go to the Firmware Update page and upload the latest version for full functionality."]);
}else{
displayContentFailed('tabContent');
}
}
},false,'','tabContent');
formMgr.createWaitContainer(top.getString('loadingPowerData'));
formMgr.batchEventDelay=1;
formMgr.startBatch();
if(powerLog==null||fresh==true){
formMgr.queueCall(hpem.getEnclosurePowerData);
}
formMgr.queueCall(hpem.getPowerSubsystemInfo);
formMgr.queueCall(hpem.getPowerCapConfig);
formMgr.endBatch();
}catch(e){
displayContentFailed('tabContent',[e.message]);
}
reconcilePage();
}
function sortTable(){
if(sortOrder=='asc'){
sortOrder='desc';
}else{
sortOrder='asc';
}
renderTable();
}
function replaceButtonText(buttonId,text){
if(document.getElementById){
var button=document.getElementById(buttonId);
if(button){
if(button.childNodes[0]){
button.childNodes[0].nodeValue=text;
}else if(button.value){
button.value=text;
}else{
button.innerHTML=text;
}
button.style.width="100%";
}
}
}
function updateTickLabels(chart,suffix){
var labels=chart.getYTicks();
document.getElementById("leftTopRange"+suffix).innerHTML=labels[2].label;
document.getElementById("rightTopRange"+suffix).innerHTML=labels[2].label;
document.getElementById("leftMidRange"+suffix).innerHTML=labels[1].label;
document.getElementById("rightMidRange"+suffix).innerHTML=labels[1].label;
document.getElementById("leftBtmRange"+suffix).innerHTML=labels[0].label;
document.getElementById("rightBtmRange"+suffix).innerHTML=labels[0].label;
}
function getUnits(name){
var select=document.getElementById(name);
return select.options[select.selectedIndex].value;
}
function getFactor(units){
if(units=="amps"){
return 1.0/(lineVoltage*threePhaseFactor);
}else if(units=="btus"){
return 3.412;
}
return 1.0;
}
function setVoltage(){
lineVoltage=getUnits("lineVoltage");
var phaseSuffix="";
if(threePhaseFactor>1)phaseSuffix=top.getString("triPhase");
if(threePhaseFactor==3)phaseSuffix=top.getString("triPhaseInt");
unitLabels["amps"]=top.getString("amps")+" ("+top.getString("at")+lineVoltage+"V"+phaseSuffix+")";
try{
setUserPreference(USER_PREFERENCES_VOLTAGE(),me.lineVoltage);
}catch(e){}
}
function convert(){
var powerBtu=null;
setVoltage();
setAvgUnits(avgUnits);
setPeakUnits(peakUnits);
getNewGraph();
var avgFactor=getFactor(avgUnits);
var avgUnitsLabel=unitLabels[avgUnits];
try{document.getElementById("curAvePower").innerHTML=(curAvePower*avgFactor).toFixed(0)+" "+avgUnitsLabel;}catch(e){}
try{
var capStr=(curPowerCap*avgFactor).toFixed(0)+" "+avgUnitsLabel
if(curPowerCap==0)capStr=top.getString("noPowerCapSet");
document.getElementById("curPowerCap").innerHTML=capStr;
}catch(e){}
powerBtu=""+(avePower*avgFactor).toFixed(0);
document.getElementById("avePower").innerHTML=powerBtu+" "+avgUnitsLabel;
powerBtu=""+(minPower*avgFactor).toFixed(0);
document.getElementById("minPower").innerHTML=powerBtu+" "+avgUnitsLabel;
var presentBtu=""+(presentPower*avgFactor).toFixed(0);
document.getElementById('curPowerConsumed').innerHTML=presentBtu+" "+avgUnitsLabel;
var peakFactor=getFactor(peakUnits);
var peakUnitsLabel=unitLabels[peakUnits];
powerBtu=""+(maxPower*peakFactor).toFixed(0);
document.getElementById("maxPower").innerHTML=powerBtu+" "+peakUnitsLabel;
}
function convertTable(){
setVoltage();
setAvgUnits(avgUnits);
renderTable();
}
function renderTable(){
var processor=new XsltProcessor('../Templates/powerMeterTable.xsl');
processor.addParameter('sortOrder',sortOrder);
processor.setSourceDocument(powerLog);
processor.addParameter('avgUnits',me.avgUnits);
processor.addParameter('presentPower',me.presentPower);
processor.addParameter('lineVoltage',me.lineVoltage);
processor.addParameter('isRedundant',isRedundant);
processor.addParameter('powerUnits',unitLabels[me.avgUnits]);
processor.addParameter('powerScaleFactor',getFactor(me.avgUnits));
processor.addParameter('stringsDoc',top.getStringsDoc());
document.getElementById('tabContent').innerHTML=processor.getOutput();
}
function getInWatts(){
try{
return me.oa1chart.getInWatts();
}catch(e){return me.inWatts;}
}
function setAvgUnits(){
me.avgUnits=getUnits("avgUnits");
try{
setUserPreference(USER_PREFERENCES_UNITS_FOR_AVG(),me.avgUnits);
me.oa1chart.setPowerUnits(me.avgUnits,(lineVoltage*threePhaseFactor));
}catch(e){}
}
function setPeakUnits(){
me.peakUnits=getUnits("peakUnits");
try{
setUserPreference(USER_PREFERENCES_UNITS_FOR_PEAK(),me.peakUnits);
me.oa1chartPeakA.setPowerUnits(me.peakUnits,(lineVoltage*threePhaseFactor));
if(isRedundant)me.oa1chartPeakB.setPowerUnits(me.peakUnits,(lineVoltage*threePhaseFactor));
}catch(e){}
}
window.status="";
var width=2;
function setBarWidth(value){
try{
me.oa1chart.setBarWidth(value);
me.oa1chartPeakA.setBarWidth(value);
if(isRedundant)me.oa1chartPeakB.setBarWidth(value);
}catch(e){}
}
function setBarHeight(value){
try{
me.oa1chart.setBarHeight(value);
me.oa1chartPeakA.setBarHeight(value);
if(isRedundant)me.oa1chartPeakB.setBarHeight(value);
}catch(e){}
}
function refreshPage(){
try{
selectTab('powerMeter',true);
}catch(e){}
}
function refreshPageTable(){
try{
selectTab('powerMeterTable',true);
}catch(e){}
}
  </script>
  
</head>
<body class="body-fit" onload="loadContent();">
  <table style="width:100%;" cellpadding="0" cellspacing="0" border="0">
    <tr>
      <td valign="bottom">
        <div class="tabSet" id="tabSet">
          <div class="tabOn" tabid="powerMeter" contextid="FORM_POWER_METER" id="powerMeter" contentlocation="../Templates/powerMeter.xsl"><script type="text/javascript">document.write(top.getString('graphicalView'));</script></div>
          <div class="tabOff" tabid="powerMeterTable" contextid="FORM_POWER_METER_TABLE" id="powerMeterTable" contentlocation="../Templates/powerMeterTable.xsl"><script type="text/javascript">document.write(top.getString('tableView'));</script></div>
          <div class="tabBottomLine"></div>
        </div>
      </td>
    </tr>
    <tr>
      <td style="padding-top:10px">
        <div id="tabContent"></div>
        <span id="waitContainer" class="WaitContainer"></span>
      </td>
    </tr>
  </table>

  <script type="text/javascript">
if(typeof(TabManager)!="undefined"){
ourTabManager.init();
}
  </script>

</body>
</html>
