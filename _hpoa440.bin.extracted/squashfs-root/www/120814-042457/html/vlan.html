<!--	(C) Copyright 2006-2014 Hewlett-Packard Development Company, L.P.
-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>HP BladeSystem Onboard Administrator</title>
<link rel="stylesheet" type="text/css" href="../css/default.css"/>
<link rel="stylesheet" type="text/css" href="../css/blue_theme.css"/>
<link rel="stylesheet" type="text/css" href="../css/MxPortalEx.css"/>
<script type="text/javascript" src="../js/EnvironConstants.js"></script>
<script type="text/javascript" src="../js/buttonManager.js"></script>
<script type="text/javascript" src="../js/tabManager.js"></script>
<script type="text/javascript" src="../js/global.js"></script>
<script type="text/javascript" src="../js/formManager.js"></script>
<script type="text/javascript" src="../js/batchManager.js"></script>
<script type="text/javascript" src="../js/displayManager.js"></script>
<script type="text/javascript" src="../js/browser.js"></script>
<script type="text/javascript" src="../js/init.js"></script>
<script type="text/javascript" src="../js/xml.js"></script>
<script type="text/javascript" src="../js/xslt.js"></script>
<script type="text/javascript" src="../js/domBuilder.js"></script>
<script type="text/javascript" src="../js/ipv4.js"></script>
<script type="text/javascript" src="../js/inputValidator.js"></script>

<script type="text/javascript">
var encNum;
var hpem=null;
function loadContent(){
encNum=parseInt(getSearchValue(location.search,'encNum'));
if(!isNaN(encNum)&&(hpem=top.mainPage.getHiddenFrame().getProxy(encNum))!=null){
hpem.registerEventHandler(vlanInfoChanged,['EVENT_VLAN_INFO_CHANGED']);
var tabId=getSearchValue(location.search,'tabId');
if(tabId!=''){
selectTab(tabId);
}else{
selectTab('vlanControl');
}
}else{
displayContentFailed('tabContent',[top.getString('noOnboardAdmin')]);
}
}
function getCurrentTab(){
return ourTabManager.getCurrentTab();
}
function selectTab(tabId){
ourTabManager.toggleTabs(tabId);
setTabContent(tabId);
}
function setTabContent(tabId){
var tab=document.getElementById(tabId);
if(tab==null){
return;
}
var contentLocation=tab.getAttribute('contentLocation');
if(contentLocation==''){
return;
}
var formMgr=new FormManager(function(success){
var vlanInfoDoc=hpem.getVlanInfo();
var processor=new XsltProcessor(contentLocation);
processor.addParameter('serviceUserAcl',hpem.getUserAccessLevel());
processor.addParameter('stringsDoc',top.getStringsDoc());
processor.addParameter('vlanInfoDoc',vlanInfoDoc);
processor.addParameter('enclosureType',hpem.getEnclosureType());
if(tabId=='vlanServer'){
processor.addParameter('deviceType','SERVER');
}else if(tabId=='vlanInterconnect'){
processor.addParameter('deviceType','INTERCONNECT');
}
document.getElementById('tabContent').innerHTML=processor.getOutput();
if(tabId=='definedVlans'){
initVlanTable();
}
reconcilePage();
var contextHelpId=tab.getAttribute('contextId');
top.mainPage.getHelpLauncher().setCurrentTopic(contextHelpId);
},true,'','tabContent');
formMgr.startBatch(true);
formMgr.queueCall(hpem.getVlanInfo);
formMgr.endBatch();
}
function initVlanTable(){
var vlanListTable=document.getElementById('vlanListTable');
if(vlanListTable){
var inputCollection=vlanListTable.getElementsByTagName('input');
for(var i=0;i<inputCollection.length;i++){
if(inputCollection[i].getAttribute('type')=='checkbox'){
inputCollection[i].onclick=vlanSelected;
var tableRow=inputCollection[i].parentNode.parentNode;
var tableCells=tableRow.getElementsByTagName('td');
for(var j=0;j<tableCells.length;j++){
tableCells[j].onclick=null;
}
}
}
}
vlanSelected();
}
function vlanSelected(){
var checkedCount=0;
var overviewTable=document.getElementById('vlanListTable');
if(overviewTable){
var inputCollection=overviewTable.getElementsByTagName('input');
for(var i=0;i<inputCollection.length;i++){
if(inputCollection[i].checked){
checkedCount++;
}
}
}
if(checkedCount==0){
ourButtonManager.disableButtonById('btnEdit');
ourButtonManager.disableButtonById('btnDelete');
}else if(checkedCount==1){
ourButtonManager.enableButtonById('btnEdit');
ourButtonManager.enableButtonById('btnDelete');
}else if(checkedCount>1){
ourButtonManager.disableButtonById('btnEdit');
ourButtonManager.enableButtonById('btnDelete');
}
}
function unloadHandlers(){
try{
hpem.removeRegisteredHandler(vlanInfoChanged);
}catch(e){}
}
function addVlan(){
location.replace('vlanAdd.html?encNum='+encNum);
}
function editVlan(){
var vlanListTable=document.getElementById('vlanListTable');
if(!vlanListTable){
return;
}
var vlanId=-1;
var inputCollection=vlanListTable.getElementsByTagName('input');
for(var i=0;i<inputCollection.length;i++){
var input=inputCollection[i];
if(input.getAttribute('type')=='checkbox'){
if(input.getAttribute('vlanId')!=''&&input.checked){
vlanId=input.getAttribute('vlanId');
}
}
}
location.replace('vlanEdit.html?encNum='+encNum+'&vlanId='+vlanId);
}
function removeVlans(){
var confirmString=top.getString('reallyDeleteVlan');
if(!confirm(confirmString)){
return;
}
var vlanListTable=document.getElementById('vlanListTable');
if(!vlanListTable){
return;
}
var selectedVlans=new Array();
var inputCollection=vlanListTable.getElementsByTagName('input');
for(var i=0;i<inputCollection.length;i++){
var input=inputCollection[i];
if(input.getAttribute('type')=='checkbox'){
if(input.getAttribute('vlanId')!=''&&input.checked){
selectedVlans.push(input.getAttribute('vlanId'));
}
}
}
if(selectedVlans.length==0){
alert('none selected');
return;
}
var formMgr=new FormManager(function(success){
if(success){
setTabContent('definedVlans');
}
},false,'errorDisplay','tabContent','waitContainer');
formMgr.createWaitContainer(top.getString('removingVlans'));
formMgr.startBatch();
for(var i=0;i<selectedVlans.length;i++){
formMgr.queueCall(hpem.removeVlan,[selectedVlans[i]]);
}
formMgr.endBatch();
}
function saveVlanConfig(){
var formMgr=new FormManager(function(success){
vlanControlCallback(success,formMgr);
},false,'errorDisplay','tabContent','waitContainer');
formMgr.createWaitContainer(top.getString('savingVlan'));
formMgr.startBatch();
formMgr.queueCall(hpem.saveConfig);
formMgr.endBatch();
}
function revertVlanConfig(){
var formMgr=new FormManager(function(success){
vlanControlCallback(success,formMgr);
},false,'errorDisplay','tabContent','waitContainer');
formMgr.createWaitContainer(top.getString('vlanRevert'));
formMgr.startBatch();
formMgr.queueCall(hpem.revertVlan,[1]);
formMgr.endBatch();
}
function vlanControlCallback(success,formMgr){
if(success){
var hasChanges=(getElementValueXpath(hpem.getVlanInfo(),'//hpoa:vlanInfo/hpoa:vlanChanged')=='1');
if(hasChanges){
formMgr.displayManager.showWaitScreen();
}
}
else{
var errorMsg=formMgr.getErrorList(true);
errorMsg+=" "+top.getString('ERR_VLAN_OPERATION');
formMgr.displayManager.showErrors(errorMsg);
}
}
function vlanInfoChanged(result){
if(getCurrentTab()=='vlanControl'||getCurrentTab()=='definedVlans'){
selectTab(getCurrentTab());
}
}
function updateVlanDevice(){
var configDocument=getConfigDevice();
setVlanInfo(configDocument,-1);
}
function setVlanSettings(){
var ourInputValidator=new InputValidator(null,'errorDisplay',true);
if(!ourInputValidator.allInputsValidate()){
ourInputValidator.updateMessages(true);
ourInputValidator.autoFocus();
return;
}
var confirmString=top.getString('vlanConfirm');
if(!confirm(confirmString)){
return;
}
var configDocument=getConfigGeneral();
var revertDelay=document.getElementById('revertDelay').value;
setVlanInfo(configDocument,revertDelay);
}
function setVlanInfo(configDocument,revertDelay){
var formMgr=new FormManager(function(success){
if(success){
var currentTab=getCurrentTab();
var hasChanges=(getElementValueXpath(formMgr.getDataByCallIndex(0),'//hpoa:vlanInfo/hpoa:vlanChanged')=='1');
if(currentTab!='vlanControl'&&currentTab!='definedVlans'&&hasChanges){
formMgr.displayManager.showWaitScreen();
setTimeout('selectTab("vlanControl");',300);
}else{
setTabContent(currentTab);
}
}
},false,'errorDisplay','tabContent','waitContainer');
formMgr.createWaitContainer(top.getString('applyingVlan'));
formMgr.startBatch();
formMgr.queueCall(hpem.setVlanInfo,[configDocument]);
if(revertDelay!=-1&&revertDelay!=''){
formMgr.queueCall(hpem.revertVlan,[revertDelay]);
}
formMgr.endBatch();
}
function getConfigDevice(){
var vlanInfoCachedDoc=hpem.getVlanInfo();
var xml=top.getXml();
var vlanInfoDoc=xml.parseXML(vlanInfoCachedDoc.xml);
var deviceTable=document.getElementById('vlanDeviceTable');
if(!deviceTable){
return null;
}
var selectCollection=deviceTable.getElementsByTagName('select');
for(var i=0;i<selectCollection.length;i++){
var curSelect=selectCollection[i];
var vlanPortId=curSelect.options[curSelect.selectedIndex].value;
var portNumber=curSelect.getAttribute('portNumber');
var xpathStr='//hpoa:vlanInfo/hpoa:portArray/hpoa:port[@hpoa:portNumber='+portNumber+']/hpoa:portVlanId';
var finalize=(i==selectCollection.length-1)?true:false;
setNodeValueXpath(vlanInfoDoc,xpathStr,vlanPortId,finalize);
}
return getElementValueXpath(vlanInfoDoc,'//hpoa:vlanInfo',true);
}
function getConfigGeneral(){
var vlanInfoCachedDoc=hpem.getVlanInfo();
var xml=top.getXml();
var vlanInfoDoc=xml.parseXML(vlanInfoCachedDoc.xml);
var vlanEnabled=document.getElementById('vlanEnabled').checked;
var defaultVlanId=document.getElementById('defaultVlanId').value;
var defaultVlanName=document.getElementById('defaultVlanName').value;
var oaVlanSelect=document.getElementById('oaVlanSelect');
var oaVlanId=oaVlanSelect.options[oaVlanSelect.selectedIndex].value;
var xpathStr='//hpoa:vlanInfo/hpoa:vlanEnable';
vlanEnabled=(vlanEnabled)?1:0;
setNodeValueXpath(vlanInfoDoc,xpathStr,vlanEnabled,false);
var oaPortArray=getElementValueXpath(vlanInfoDoc,'//hpoa:vlanInfo/hpoa:portArray',true);
if(oaPortArray){
for(var i=0;i<oaPortArray.childNodes.length;i++){
if(oaPortArray.childNodes[i].nodeName=='hpoa:port'&&oaPortArray.childNodes[i].getAttribute("hpoa:deviceType")=="OA"){
var portNumber=oaPortArray.childNodes[i].getAttribute("hpoa:portNumber")
xpathStr='//hpoa:vlanInfo/hpoa:portArray/hpoa:port[@hpoa:portNumber='+portNumber+']/hpoa:portVlanId';
setNodeValueXpath(vlanInfoDoc,xpathStr,oaVlanId,false);
}
}
}
xpathStr='//hpoa:vlanInfo/hpoa:cfgArray/hpoa:cfg/hpoa:vlanId';
setNodeValueXpath(vlanInfoDoc,xpathStr,defaultVlanId,true);
xpathStr='//hpoa:vlanInfo/hpoa:cfgArray/hpoa:cfg/hpoa:vlanName';
setNodeValueXpath(vlanInfoDoc,xpathStr,defaultVlanName,true);
return getElementValueXpath(vlanInfoDoc,'//hpoa:vlanInfo',true);
}
</script>
</head>
<body style="margin:10px;" onload="loadContent();" onunload="unloadHandlers();">
    
    <b><script type="text/javascript">document.write(top.getString('vlanLong'));</script></b><br />
	<span class="whiteSpacer">&#160;</span><br />
    
    <table cellpadding="0" cellspacing="0" border="0" width="100%">
      <tr>
        <td valign="bottom">
          <div class="tabSet" id="tabSet">
            <div class="tabOn" tabid="vlanControl" contextId="FORM_VLAN_CONTROL" id="vlanControl" contentLocation="../Forms/VlanControl.xsl"><script type="text/javascript">document.write(top.getString('vlanControl'));</script></div>
            <div class="tabOff" tabid="vlanSettings" contextId="FORM_VLAN_SETUP" id="vlanSettings" contentLocation="../Forms/VlanSettings.xsl"><script type="text/javascript">document.write(top.getString('vlanSettings'));</script></div>
            <div class="tabOff" tabid="definedVlans" contextId="FORM_DEFINED_VLANS" id="definedVlans" contentLocation="../Forms/VlanList.xsl"><script type="text/javascript">document.write(top.getString('definedVlans'));</script></div>
				<div class="tabOff" tabid="vlanServer" contextId="FORM_VLAN_DEVICE_BAYS" id="vlanServer" contentLocation="../Forms/VlanDeviceList.xsl"><script type="text/javascript">document.write(top.getString('serverBays'));</script></div>
            <div class="tabOff" tabid="vlanInterconnect" contextId="FORM_VLAN_INTERCONNECT_BAYS" id="vlanInterconnect" contentLocation="../Forms/VlanDeviceList.xsl"><script type="text/javascript">document.write(top.getString('interconnectBays'));</script></div>
            <div class="tabBottomLine"></div>
          </div>					
        </td>
      </tr>
      <tr>
        <td style="padding-top:10px;">
          <div id="tabContent"></div>
        </td>
      </tr>
    </table>

    <script type="text/javascript">
if(typeof(TabManager)!="undefined"){
ourTabManager.init();
}
    </script>

	<div id="waitContainer"></div>
</body>
</html>
