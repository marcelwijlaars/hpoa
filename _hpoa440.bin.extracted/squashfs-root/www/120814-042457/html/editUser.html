<!--  (C) Copyright 2006-2014 Hewlett-Packard Development Company, L.P.
-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>HP BladeSystem Onboard Administrator</title>
<link rel="stylesheet" type="text/css" href="../css/default.css"/>
<link rel="stylesheet" type="text/css" href="../css/blue_theme.css"/>
<link rel="stylesheet" type="text/css" href="../css/MxPortalEx.css"/>
<script type="text/javascript" src="../js/EnvironConstants.js"></script>
<script type="text/javascript" src="../js/inputValidator.js"></script>
<script type="text/javascript" src="../js/buttonManager.js"></script>
<script type="text/javascript" src="../js/tabManager.js"></script>
<script type="text/javascript" src="../js/tableManager.js"></script>
<script type="text/javascript" src="../js/users.js"></script>
<script type="text/javascript" src="../js/formManager.js"></script>
<script type="text/javascript" src="../js/displayManager.js"></script>
<script type="text/javascript" src="../js/global.js"></script>
<script type="text/javascript" src="../js/browser.js"></script>
<script type="text/javascript" src="../js/init.js"></script>
<script type="text/javascript" src="../js/xml.js"></script>
<script type="text/javascript" src="../js/xslt.js"></script>

<script type="text/javascript">
var encNum;
var username;
var action;
var hpem=null;
var formMgr=null;
var ourInputValidator=null;
function loadContent(){
try{
encNum=parseInt(getSearchValue(location.search,'encNum'));
username=getSearchValue(location.search,'username');
action=getSearchValue(location.search,'action');
try{
top.mainPage.setMainTitle(top.getString('editLocalUser'));
top.mainPage.getNavigationFrame().highlightUser(username,encNum);
}catch(e){}
if(!isNaN(encNum)&&(hpem=top.mainPage.getHiddenFrame().getProxy(encNum))!=null){
var formMgr=new FormManager(function(success){
ourTabManager.toggleTabs('userInformation');
setTabContent('userInformation');
hpem.registerEventHandler(userRemoved,['EVENT_USER_DELETED']);
},false,'','tabContent');
formMgr.startBatch(true);
formMgr.queueCall(hpem.getPasswordSettings);
formMgr.endBatch();
}else{
displayContentFailed('bodyContent',[top.getString('noOnboardAdmin')]);
}
}catch(e){
displayContentFailed('bodyContent',[e.message]);
}
}
function getCurrentTab(){
return ourTabManager.getCurrentTab();
}
function setTabContent(tabId){
var contentTab=document.getElementById(tabId);
var contentLocation=contentTab.getAttribute('contentLocation');
var contextId=contentTab.getAttribute("context-id");
top.mainPage.getHelpLauncher().setCurrentTopic(contextId);
if(contentLocation=='../Templates/editUser.xsl'){
if(hpem!=null){
if(action=='add'){
var xml=importModule('xml');
var userInfoDoc=xml.parseXML('<hpoa:bayPermissions xmlns:hpoa="hpoa.xsd" />');
var processor=new XsltProcessor('../Templates/editUser.xsl');
processor.addParameter('stringsDoc',top.getStringsDoc());
processor.addParameter('action',action);
processor.addParameter('userInfoDoc',userInfoDoc);
processor.addParameter('encNum',encNum);
processor.addParameter('serviceUserAcl',hpem.getUserAccessLevel());
processor.addParameter('userOaAccess',hpem.getUserOaPermission());
processor.addParameter('enclosureType',hpem.getEnclosureType());
processor.addParameter('lcdInfoDoc',hpem.getLcdInfo());
processor.addParameter('isTower',hpem.getIsTower()+"");
processor.addParameter('numDeviceBays',hpem.getNumBlades());
processor.addParameter('numIoBays',hpem.getNumTrays());
processor.addParameter('passwordSettingsDoc',hpem.getPasswordSettings());
document.getElementById('tabContent').innerHTML=processor.getOutput();
var waitPhrase=top.getString('addingUser');
var waitDescription=top.getString('addingUserSettings');
formMgr=new FormManager(userAddedResponse);
formMgr.createWaitContainer(waitPhrase,waitDescription);
ourInputValidator=new InputValidator(null,'errorDisplay',true);
reconcilePage();
loadCurrentSettings(encNum);
}else if(action=='edit'){
var userInfoDoc=hpem.getUserInfo(username);
if(username!=''&&userInfoDoc!=null){
var processor=new XsltProcessor('../Templates/editUser.xsl');
processor.addParameter('encNum',encNum);
processor.addParameter('stringsDoc',top.getStringsDoc());
processor.addParameter('action',action);
processor.addParameter('userInfoDoc',userInfoDoc);
processor.addParameter('serviceUserAcl',hpem.getUserAccessLevel());
processor.addParameter('userOaAccess',hpem.getUserOaPermission());
processor.addParameter('enclosureType',hpem.getEnclosureType());
processor.addParameter('lcdInfoDoc',hpem.getLcdInfo());
processor.addParameter('isTower',hpem.getIsTower()+"");
processor.addParameter('numDeviceBays',hpem.getNumBlades());
processor.addParameter('numIoBays',hpem.getNumTrays());
processor.addParameter('passwordSettingsDoc',hpem.getPasswordSettings());
if(top.getTopology().getProxyLocal().getCurrentServiceUser()==username){
processor.addParameter('isCurrentUser','true');
}
document.getElementById('tabContent').innerHTML=processor.getOutput();
var waitPhrase=top.getString('updatingUser');
var waitDescription=top.getString('updatingUserSettings');
formMgr=new FormManager(userUpdated,false,'errorDisplay','tabContent');
formMgr.createWaitContainer(waitPhrase,waitDescription);
ourInputValidator=new InputValidator(null,'errorDisplay',true);
reconcilePage();
loadCurrentSettings(encNum);
}else{
displayContentFailed('bodyContent',['The user information could not be retrieved.','The user may have been removed.']);
}
}
}else{
displayContentFailed('bodyContent',[top.getString('noOnboardAdmin')]);
}
}else{
if(hpem!=null){
formMgr=new FormManager(function(success){
if(success){
var res=formMgr.getDataByCallIndex(0);
var fingerprint=getElementValueXpath(res,"//hpoa:user-cert/hpoa:fingerprint");
var processor=new XsltProcessor("../Templates/usercertificateupload.xsl");
processor.addParameter('stringsDoc',top.getStringsDoc());
processor.addParameter('fingerprint',fingerprint);
processor.addParameter('username',username);
processor.addParameter('encNum',encNum);
processor.addParameter('serviceuser',hpem.getCurrentServiceUser());
processor.addParameter('serviceUserAcl',hpem.getUserAccessLevel());
document.getElementById('tabContent').innerHTML=processor.getOutput();
reconcilePage();
}else{
var fingerprint='';
var processor=new XsltProcessor("../Templates/usercertificateupload.xsl");
processor.addParameter('stringsDoc',top.getStringsDoc());
processor.addParameter('username',username);
processor.addParameter('encNum',encNum);
processor.addParameter('fingerprint',fingerprint);
processor.addParameter('serviceuser',hpem.getCurrentServiceUser());
processor.addParameter('serviceUserAcl',hpem.getUserAccessLevel());
document.getElementById('tabContent').innerHTML=processor.getOutput();
reconcilePage();
}
},true,'','tabContent');
with(formMgr){
startBatch(true);
queueCall(hpem.getUserCertificateInfo,[username]);
endBatch();
}
}else{
displayContentFailed('waitContainer',[top.getString('noOnboardAdmin')]);
}
}
}
function addUser(){
if(ourInputValidator.allInputsValidate()){
uInfo=getUserInfo(encNum);
formMgr.startBatch();
formMgr.queueCall(hpem.addUser,[uInfo['username'],uInfo['password']],['lblUsername','lblPwd']);
formMgr.endBatch();
}
else{
ourInputValidator.updateMessages(true);
ourInputValidator.autoFocus();
}
}
function userAddedResponse(success){
if(success==true){
applyUserSettings(userAdded);
}
else{
formMgr.reset();
}
}
function applyUserSettings(callback){
try{
if(typeof(callback)!='undefined'&&callback){
formMgr=new FormManager(callback,false,'errorDisplay','tabContent');
}
else{
formMgr=new FormManager(userUpdated,false,'errorDisplay','tabContent');
}
if(ourInputValidator.allInputsValidate()){
uInfo=getUserInfo(encNum);
formMgr.startBatch();
formMgr.queueCall(hpem.setUserFullname,[uInfo['username'],uInfo['fullName']],['lblFullname']);
formMgr.queueCall(hpem.setUserContact,[uInfo['username'],uInfo['contact']],['lblContact']);
if(uInfo['password']!=''){
formMgr.queueCall(hpem.setUserPassword,[uInfo['username'],uInfo['password']],[]);
}
if(uInfo['userBayAcl']!=null){
formMgr.queueCall(hpem.setUserBayAcl,[uInfo['username'],uInfo['userBayAcl']]);
}
if(uInfo['userEnabled']!=null){
if(uInfo['userEnabled']==true){
formMgr.queueCall(hpem.enableUser,[uInfo['username']],[],['10','11']);
}
else{
formMgr.queueCall(hpem.disableUser,[uInfo['username']],[],['10','11']);
}
}
if(uInfo['permissionsToAdd']!=null){
formMgr.queueCall(hpem.addUserBayAccess,[uInfo['username'],uInfo['permissionsToAdd']]);
}
if(uInfo['permissionsToRemove']!=null){
formMgr.queueCall(hpem.removeUserBayAccess,[uInfo['username'],uInfo['permissionsToRemove']],[],['316']);
}
formMgr.endBatch();
}
else{
ourInputValidator.updateMessages(true);
ourInputValidator.autoFocus();
}
uInfo=null;
}
catch(e){}
}
function userUpdated(success){
if(success){
if(hpem.getUserAccessLevel()=='ADMINISTRATOR'&&hpem.getUserOaPermission()==true){
document.getElementById('tabContent').innerHTML='';
setTimeout('loadUserOverview()',500);
}
}
}
function userAdded(success){
if(success){
document.getElementById('tabContent').innerHTML='';
setTimeout('loadUserOverview()',500);
}
else{
alert('Error adding user');
}
}
function userRemoved(result){
var removedUsername=getElementValueXpath(result,'//hpoa:message');
if(removedUsername==username){
document.getElementById('bodyContent').innerHTML=top.getString('theUserWasRemoved');
}
}
function unmap(){
var confirmString=top.getString('reallyRemoveCertificate');
if(!confirm(confirmString)){
return;
}
var username=getSearchValue(location.search,'username');
formMgr=new FormManager(function(success){
if(success){
var fingerprint='';
var processor=new XsltProcessor("../Templates/usercertificateupload.xsl");
processor.addParameter('stringsDoc',top.getStringsDoc());
processor.addParameter('username',username);
processor.addParameter('encNum',encNum);
processor.addParameter('fingerprint',fingerprint);
processor.addParameter('serviceuser',hpem.getCurrentServiceUser());
processor.addParameter('serviceUserAcl',hpem.getUserAccessLevel());
document.getElementById('tabContent').innerHTML=processor.getOutput();
reconcilePage();
}
else
{
displayContentFailed('usercertupload',formMgr.getErrorsArray());
}
},false,'errorDisplay','tabContent');
formMgr.createWaitContainer(top.getString('removingUserCert'));
formMgr.startBatch();
formMgr.queueCall(hpem.removeUserCertificate,[username]);
formMgr.endBatch();
}
function downloadCertificate(){
var username=getSearchValue(location.search,'username');
var url=document.getElementById('certUrl').value;
if(url!=''){
formMgr=new FormManager(function(success){
if(success){
var formMgr2=new FormManager(function(success){
var res=formMgr2.getDataByCallIndex(0);
var fingerprint=getElementValueXpath(res,"//hpoa:user-cert/hpoa:fingerprint");
if(fingerprint!=''){
var processor=new XsltProcessor("../Templates/usercertificateupload.xsl");
processor.addParameter('stringsDoc',top.getStringsDoc());
processor.addParameter('username',username);
processor.addParameter('encNum',encNum);
processor.addParameter('fingerprint',fingerprint);
processor.addParameter('serviceuser',hpem.getCurrentServiceUser());
processor.addParameter('serviceUserAcl',hpem.getUserAccessLevel());
document.getElementById('tabContent').innerHTML=processor.getOutput();
reconcilePage();
}
},false,'errorDisplay','tabContent');
with(formMgr2){
startBatch(true);
queueCall(hpem.getUserCertificateInfo,[username]);
endBatch();
}
}else{
displayContentFailed('usercertupload',formMgr.getErrorsArray());
}
},false,'errorDisplay','tabContent');
formMgr.createWaitContainer(top.getString('downloadingCertificate'));
formMgr.startBatch();
formMgr.queueCall(hpem.downloadUserCertificate,[username,url]);
formMgr.endBatch();
}else{
alert(top.getString('enterValidCertURL'));
}
}
function mapusercert(){
var username=getSearchValue(location.search,'username');
var certContent=document.getElementById('certificateContents').value;
if(certContent!=''){
if(true){
formMgr=new FormManager(function(success){
if(success){
var formMgr2=new FormManager(function(success){
var res=formMgr2.getDataByCallIndex(0);
var fingerprint=getElementValueXpath(res,"//hpoa:user-cert/hpoa:fingerprint");
if(fingerprint!=''){
var processor=new XsltProcessor("../Templates/usercertificateupload.xsl");
processor.addParameter('stringsDoc',top.getStringsDoc());
processor.addParameter('username',username);
processor.addParameter('encNum',encNum);
processor.addParameter('fingerprint',fingerprint);
processor.addParameter('serviceuser',hpem.getCurrentServiceUser());
processor.addParameter('serviceUserAcl',hpem.getUserAccessLevel());
document.getElementById('tabContent').innerHTML=processor.getOutput();
reconcilePage();
}
},false,'errorDisplay','tabContent');
with(formMgr2){
startBatch(true);
queueCall(hpem.getUserCertificateInfo,[username]);
endBatch();
}
}else{
displayContentFailed('tabContent',[e.message]);
}
},false,'errorDisplay','tabContent');
formMgr.createWaitContainer(top.getString('sendingCert'));
formMgr.startBatch();
formMgr.queueCall(hpem.setUserCertificate,[username,certContent]);
formMgr.endBatch();
}
}else{
alert(top.getString('alrtProvideValidCertBeforeSubmit'));
}
}
function loadUserOverview(){
location='localUsers.html?encNum='+encNum;
}
  </script>
</head>
<body style="margin:10px;" onload="loadContent();">
  <div id="bodyContent">
      <table cellpadding="0" cellspacing="0" border="0" width="100%">
        <tr>
          <td valign="bottom">
          <div class="tabSet" id="tabSet">
            <div class="tabOff" context-id="FORM_USER_EDIT"  tabid="userInformation"  id="userInformation" contentLocation="../Templates/editUser.xsl"><script type="text/javascript">document.write(top.getString('userInformation'));</script></div>
                <div class="tabOff" context-id="FORM_USER_EDIT_CERTIFICATE"  tabid="certificateSettings"  id="certificateSettings" contentLocation="../Templates/usercertificateupload.xsl"><script type="text/javascript">document.write(top.getString('certificateInformation'));</script></div>				
                <div class="tabBottomLine"></div>
                </div>
                </td>
            </tr>
      <tr>
        <td style="padding-top:10px;">
        <div id="tabContent"></div>
        <div id="waitContainer" class="waitContainer"></div>
        </td>
      </tr>
    </table>

    <script type="text/javascript">
if(typeof(TabManager)!="undefined"){
ourTabManager.init();
}
    </script>

    </div>
    
</body>
</html>

